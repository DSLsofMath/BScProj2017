<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Learn You a Physics for Great Good!</title>
    <link rel="stylesheet" type="text/css" href="../style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-AMS_CHTML-full" type="text/javascript"></script>
  </head>

  <body>
    <header>
      <a href="../index.html"><h1>Learn You a <span class="physics">Physics</span> for Great Good!</h1></a>
      <nav>
        <span>Previous: <a href="../Units/Introduction.html">Introduction</a></span>
        <a href="../index.html">Table of contents</a>
        <span>Next: <a href="../Units/Value-level units.html">Value-level units</a></span>
      </nav>
    </header>

    <main>
      <h1 id="quantities">Quantities</h1>
<p>We will now create a data type for quantities and combine units on value-level and type-level. Just as before, a bunch of GHC-extensions are necessary.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="ot">{-# LANGUAGE DataKinds #-}</span></a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="ot">{-# LANGUAGE GADTs #-}</span></a>
<a class="sourceLine" id="cb1-3" data-line-number="3"><span class="ot">{-# LANGUAGE KindSignatures #-}</span></a>
<a class="sourceLine" id="cb1-4" data-line-number="4"><span class="ot">{-# LANGUAGE TypeFamilies #-}</span></a>
<a class="sourceLine" id="cb1-5" data-line-number="5"><span class="ot">{-# LANGUAGE UndecidableInstances #-}</span></a>
<a class="sourceLine" id="cb1-6" data-line-number="6"><span class="ot">{-# LANGUAGE TypeOperators #-}</span></a></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="kw">module</span> <span class="dt">Units.Quantity</span></a>
<a class="sourceLine" id="cb2-2" data-line-number="2">( length</a>
<a class="sourceLine" id="cb2-3" data-line-number="3">, mass</a>
<a class="sourceLine" id="cb2-4" data-line-number="4">, time</a>
<a class="sourceLine" id="cb2-5" data-line-number="5">, current</a>
<a class="sourceLine" id="cb2-6" data-line-number="6">, temperature</a>
<a class="sourceLine" id="cb2-7" data-line-number="7">, substance</a>
<a class="sourceLine" id="cb2-8" data-line-number="8">, luminosity</a>
<a class="sourceLine" id="cb2-9" data-line-number="9">, one</a>
<a class="sourceLine" id="cb2-10" data-line-number="10">, velocity</a>
<a class="sourceLine" id="cb2-11" data-line-number="11">, acceleration</a>
<a class="sourceLine" id="cb2-12" data-line-number="12">, force</a>
<a class="sourceLine" id="cb2-13" data-line-number="13">, momentum</a>
<a class="sourceLine" id="cb2-14" data-line-number="14">, (<span class="fu">#</span>)</a>
<a class="sourceLine" id="cb2-15" data-line-number="15">, (<span class="fu">+#</span>)</a>
<a class="sourceLine" id="cb2-16" data-line-number="16">, (<span class="fu">-#</span>)</a>
<a class="sourceLine" id="cb2-17" data-line-number="17">, (<span class="fu">*#</span>)</a>
<a class="sourceLine" id="cb2-18" data-line-number="18">, (<span class="fu">/#</span>)</a>
<a class="sourceLine" id="cb2-19" data-line-number="19">, sinq</a>
<a class="sourceLine" id="cb2-20" data-line-number="20">, cosq</a>
<a class="sourceLine" id="cb2-21" data-line-number="21">, asinq</a>
<a class="sourceLine" id="cb2-22" data-line-number="22">, acosq</a>
<a class="sourceLine" id="cb2-23" data-line-number="23">, atanq</a>
<a class="sourceLine" id="cb2-24" data-line-number="24">, expq</a>
<a class="sourceLine" id="cb2-25" data-line-number="25">, logq</a>
<a class="sourceLine" id="cb2-26" data-line-number="26">)</a>
<a class="sourceLine" id="cb2-27" data-line-number="27"><span class="kw">where</span></a></code></pre></div>
<div class="sourceCode" id="cb3"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Units.ValueLevel</span> <span class="kw">as</span> <span class="dt">V</span></a>
<a class="sourceLine" id="cb3-2" data-line-number="2"><span class="kw">import</span>           <span class="dt">Units.TypeLevel</span>  <span class="kw">as</span> <span class="dt">T</span></a>
<a class="sourceLine" id="cb3-3" data-line-number="3"><span class="kw">import</span>           <span class="dt">Prelude</span>          <span class="kw">as</span> <span class="dt">P</span> <span class="kw">hiding</span> (length, div)</a></code></pre></div>
<h2 id="the-data-type">The data type</h2>
<p>First we create the data type for quantities.</p>
<p>[PaJa: förklara gärna varför typ-arg. inte är i samma ordning som värde-arg.]</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="kw">data</span> <span class="dt">Quantity</span> (<span class="ot">u ::</span> <span class="dt">T.Unit</span>) (<span class="ot">v ::</span> <span class="fu">*</span>) <span class="kw">where</span></a>
<a class="sourceLine" id="cb4-2" data-line-number="2">  <span class="dt">Quantity</span><span class="ot"> ::</span> v <span class="ot">-&gt;</span> <span class="dt">V.Unit</span> <span class="ot">-&gt;</span> <span class="dt">Quantity</span> u v</a></code></pre></div>
<ul>
<li><code>data Quantity</code> creates a <em>type</em>.</li>
<li><code>u</code> is a <em>type</em> and <code>T.Unit</code> is a <em>kind</em>. This makes our data type have a type parameter where the type must have the kind <code>T.Unit</code>.</li>
<li><code>v :: *</code> means that <code>v</code>, as in <strong>v</strong>alue, has the kind <code>*</code>, which is the kind of types that can have values. <code>v</code> could for instance be <code>Double</code> or <code>Integer</code>.</li>
<li><code>Quantity</code> on the row below is a value constructor.</li>
<li>The value constructor has two <em>value</em>-parameters which should have certain <em>types</em>.
<ul>
<li><code>v</code> is a type which represents a number.</li>
<li><code>V.Unit</code> is the unit of the quantity on value-level.</li>
</ul></li>
<li><code>Quantity</code> on the upper row is the name of a type (or rather a type constructor since it has the two type-parameters <code>u</code> and <code>v</code>) while <code>Quantity</code> on the lower row is the name of a value (value constructor). Same names but different things. It’s possible to do this, just like the definition below is possible, with the same name on different things on different sides of the equals-sign.</li>
</ul>
<p>The corresponding data type without units on type-level would look like</p>
<p>[PaJa: jag föreslår att ni använder GADT-syntax även här för att underlätta jämförelsen.]</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="kw">data</span> <span class="dt">Quantity</span> v <span class="fu">=</span> <span class="dt">Quantity</span> <span class="dt">V.Unit</span> v</a></code></pre></div>
<p><code>u</code> in the prior definition should not be confused with <code>V.Unit</code> in the latter. <code>u</code> is the name of an unbound type, which should be of kind <code>T.Unit</code>, while <code>V.Unit</code> means that a value of type <code>V.Unit</code> should be here. Due to syntactical reasons it stands <code>u</code> instead of <code>T.Unit</code>, but one can think it stands <code>T.Unit</code> if it makes it easier to understand.</p>
<h2 id="a-taste-of-types">A taste of types</h2>
<p>We will implement all arithmetic operations on <code>Quantity</code>, but for now, to get a taste of types, we show here addition and multiplication and some examples of values of type <code>Quantity</code>.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb6-1" data-line-number="1"><span class="ot">quantityAdd ::</span> (<span class="dt">Num</span> v) <span class="ot">=&gt;</span> <span class="dt">Quantity</span> u v <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb6-2" data-line-number="2">                          <span class="dt">Quantity</span> u v <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb6-3" data-line-number="3">                          <span class="dt">Quantity</span> u v</a>
<a class="sourceLine" id="cb6-4" data-line-number="4">quantityAdd (<span class="dt">Quantity</span> v1 u) (<span class="dt">Quantity</span> v2 _) <span class="fu">=</span> <span class="dt">Quantity</span> (v1<span class="fu">+</span>v2) u</a></code></pre></div>
<p>The type is interpreted as follows: two values of type <code>Quantity u v</code> is the input, where <code>u</code> is the type-level unit. The output is also a value of <code>Quantity u v</code>.</p>
<p>The type of the function forces the inputs to have the same units. For this reason, the unit on value-level doesn’t matter on one of the arguments, because they will be the same. (It’s possible to create values where the units on value-level and type-level don’t match. We’ll come back to this later.)</p>
<p>Multiplication is</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb7-1" data-line-number="1"><span class="ot">quantityMul ::</span> (<span class="dt">Num</span> v) <span class="ot">=&gt;</span> <span class="dt">Quantity</span> u1 v <span class="ot">-&gt;</span> </a>
<a class="sourceLine" id="cb7-2" data-line-number="2">                          <span class="dt">Quantity</span> u2 v <span class="ot">-&gt;</span>             </a>
<a class="sourceLine" id="cb7-3" data-line-number="3">                          <span class="dt">Quantity</span> (u1 <span class="ot">`Mul`</span> u2) v</a>
<a class="sourceLine" id="cb7-4" data-line-number="4">quantityMul (<span class="dt">Quantity</span> v1 u1) (<span class="dt">Quantity</span> v2 u2) <span class="fu">=</span> </a>
<a class="sourceLine" id="cb7-5" data-line-number="5">  <span class="dt">Quantity</span> (v1<span class="fu">*</span>v2) (u1 <span class="ot">`V.mul`</span> u2)</a></code></pre></div>
<p>The type has the following interpretation: two valus of type <code>Quantity ux v</code> is input, where <code>ux</code> are two types representing (potentially different) units. As output, a value of type <code>Quantity</code> is returned. The type in the <code>Quantity</code> will be the type that is the product of the two units in.</p>
<p>Now on to some example values.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb8-1" data-line-number="1"><span class="ot">width ::</span> <span class="dt">Quantity</span> <span class="dt">T.Length</span> <span class="dt">Double</span></a>
<a class="sourceLine" id="cb8-2" data-line-number="2">width <span class="fu">=</span> <span class="dt">Quantity</span> <span class="fl">0.5</span> V.length</a></code></pre></div>
<div class="sourceCode" id="cb9"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb9-1" data-line-number="1"><span class="ot">height ::</span> <span class="dt">Quantity</span> <span class="dt">T.Length</span> <span class="dt">Double</span></a>
<a class="sourceLine" id="cb9-2" data-line-number="2">height <span class="fu">=</span> <span class="dt">Quantity</span> <span class="fl">0.3</span> V.length</a></code></pre></div>
<div class="sourceCode" id="cb10"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb10-1" data-line-number="1"><span class="kw">type</span> <span class="dt">Area</span> <span class="fu">=</span> <span class="dt">Mul</span> <span class="dt">T.Length</span> <span class="dt">T.Length</span></a></code></pre></div>
<p>The following example shows that during a multiplication, the types will change, as they should. The units change not only on value-level but also on type-level.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb11-1" data-line-number="1"><span class="ot">area ::</span> <span class="dt">Quantity</span> <span class="dt">Area</span> <span class="dt">Double</span></a>
<a class="sourceLine" id="cb11-2" data-line-number="2">area <span class="fu">=</span> quantityMul width height</a></code></pre></div>
<p>Having type-level units is used below, to enforce at compile-time that only allowed operations are performed.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb12-1" data-line-number="1"><span class="co">-- Doesn&#39;t even compile</span></a>
<a class="sourceLine" id="cb12-2" data-line-number="2">weird <span class="fu">=</span> quantityAdd width area</a></code></pre></div>
<p>If the units only were value-level, this error would be noticed only at run-time.</p>
<h2 id="pretty-printer">Pretty-printer</h2>
<p>Let’s do a pretty-printer for quantities. Most of the work is already done by the units at value-level.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb13-1" data-line-number="1"><span class="ot">showQuantity ::</span> (<span class="dt">Show</span> v) <span class="ot">=&gt;</span> <span class="dt">Quantity</span> u v <span class="ot">-&gt;</span> <span class="dt">String</span></a>
<a class="sourceLine" id="cb13-2" data-line-number="2">showQuantity (<span class="dt">Quantity</span> v u) <span class="fu">=</span> show v <span class="fu">++</span> <span class="st">&quot; &quot;</span> <span class="fu">++</span> show u</a></code></pre></div>
<div class="sourceCode" id="cb14"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb14-1" data-line-number="1"><span class="kw">instance</span> (<span class="dt">Show</span> v) <span class="ot">=&gt;</span> <span class="dt">Show</span> (<span class="dt">Quantity</span> u v) <span class="kw">where</span></a>
<a class="sourceLine" id="cb14-2" data-line-number="2">  show <span class="fu">=</span> showQuantity</a></code></pre></div>
<h2 id="comparsions">Comparsions</h2>
<p>It’s useful to be able to compare quantities. Perhaps one wants to know which of two amounts of energy is the largest. But what’s the largest of <code>1 J</code> and <code>1 m</code>? That’s no meaningful comparsion since the units don’t match. This behaviour is prevented by having type-level units.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb15-1" data-line-number="1"><span class="ot">quantityEq ::</span> (<span class="dt">Eq</span> v) <span class="ot">=&gt;</span> <span class="dt">Quantity</span> u v <span class="ot">-&gt;</span> <span class="dt">Quantity</span> u v <span class="ot">-&gt;</span> <span class="dt">Bool</span></a>
<a class="sourceLine" id="cb15-2" data-line-number="2">quantityEq (<span class="dt">Quantity</span> v1 _) (<span class="dt">Quantity</span> v2 _) <span class="fu">=</span> v1 <span class="fu">==</span> v2</a>
<a class="sourceLine" id="cb15-3" data-line-number="3"></a>
<a class="sourceLine" id="cb15-4" data-line-number="4"><span class="kw">instance</span> (<span class="dt">Eq</span> v) <span class="ot">=&gt;</span> <span class="dt">Eq</span> (<span class="dt">Quantity</span> u v) <span class="kw">where</span></a>
<a class="sourceLine" id="cb15-5" data-line-number="5">  (<span class="fu">==</span>) <span class="fu">=</span> quantityEq</a></code></pre></div>
<div class="sourceCode" id="cb16"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb16-1" data-line-number="1"></a>
<a class="sourceLine" id="cb16-2" data-line-number="2"><span class="ot">quantityCompare ::</span> (<span class="dt">Ord</span> v) <span class="ot">=&gt;</span> <span class="dt">Quantity</span> u v <span class="ot">-&gt;</span> </a>
<a class="sourceLine" id="cb16-3" data-line-number="3">                              <span class="dt">Quantity</span> u v <span class="ot">-&gt;</span> <span class="dt">Ordering</span></a>
<a class="sourceLine" id="cb16-4" data-line-number="4">quantityCompare (<span class="dt">Quantity</span> v1 _) (<span class="dt">Quantity</span> v2 _) <span class="fu">=</span></a>
<a class="sourceLine" id="cb16-5" data-line-number="5">  compare v1 v2</a></code></pre></div>
<div class="sourceCode" id="cb17"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb17-1" data-line-number="1"><span class="kw">instance</span> (<span class="dt">Ord</span> v) <span class="ot">=&gt;</span> <span class="dt">Ord</span> (<span class="dt">Quantity</span> u v) <span class="kw">where</span></a>
<a class="sourceLine" id="cb17-2" data-line-number="2">  compare <span class="fu">=</span> quantityCompare</a></code></pre></div>
<h2 id="arithmetic-on-quantities">Arithmetic on quantities</h2>
<p>Let’s implement the arithmetic operations on <code>Quantity</code>. Basically it’s all about creating functions with the correct type-level units.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb18-1" data-line-number="1"><span class="kw">infixl</span> <span class="dv">6</span> <span class="fu">+#</span></a>
<a class="sourceLine" id="cb18-2" data-line-number="2"><span class="ot">(+#) ::</span> (<span class="dt">Num</span> v) <span class="ot">=&gt;</span> <span class="dt">Quantity</span> u v <span class="ot">-&gt;</span> <span class="dt">Quantity</span> u v <span class="ot">-&gt;</span> </a>
<a class="sourceLine" id="cb18-3" data-line-number="3">                   <span class="dt">Quantity</span> u v</a>
<a class="sourceLine" id="cb18-4" data-line-number="4">(<span class="fu">+#</span>) <span class="fu">=</span> quantityAdd</a>
<a class="sourceLine" id="cb18-5" data-line-number="5"></a>
<a class="sourceLine" id="cb18-6" data-line-number="6"><span class="kw">infixl</span> <span class="dv">6</span> <span class="fu">-#</span></a>
<a class="sourceLine" id="cb18-7" data-line-number="7"><span class="ot">(-#) ::</span> (<span class="dt">Num</span> v) <span class="ot">=&gt;</span> <span class="dt">Quantity</span> u v <span class="ot">-&gt;</span> <span class="dt">Quantity</span> u v <span class="ot">-&gt;</span> </a>
<a class="sourceLine" id="cb18-8" data-line-number="8">                   <span class="dt">Quantity</span> u v</a>
<a class="sourceLine" id="cb18-9" data-line-number="9">(<span class="dt">Quantity</span> v1 u) <span class="fu">-#</span> (<span class="dt">Quantity</span> v2 _) <span class="fu">=</span> <span class="dt">Quantity</span> (v1<span class="fu">-</span>v2) u</a>
<a class="sourceLine" id="cb18-10" data-line-number="10"></a>
<a class="sourceLine" id="cb18-11" data-line-number="11"><span class="kw">infixl</span> <span class="dv">7</span> <span class="fu">*#</span></a>
<a class="sourceLine" id="cb18-12" data-line-number="12"><span class="ot">(*#) ::</span> (<span class="dt">Num</span> v) <span class="ot">=&gt;</span> <span class="dt">Quantity</span> u1 v <span class="ot">-&gt;</span> <span class="dt">Quantity</span> u2 v <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb18-13" data-line-number="13">                   <span class="dt">Quantity</span> (u1 <span class="ot">`Mul`</span> u2) v</a>
<a class="sourceLine" id="cb18-14" data-line-number="14">(<span class="fu">*#</span>) <span class="fu">=</span> quantityMul</a>
<a class="sourceLine" id="cb18-15" data-line-number="15"></a>
<a class="sourceLine" id="cb18-16" data-line-number="16"><span class="kw">infixl</span> <span class="dv">7</span> <span class="fu">/#</span></a>
<a class="sourceLine" id="cb18-17" data-line-number="17"><span class="ot">(/#) ::</span> (<span class="dt">Fractional</span>  v) <span class="ot">=&gt;</span> <span class="dt">Quantity</span> u1 v <span class="ot">-&gt;</span> </a>
<a class="sourceLine" id="cb18-18" data-line-number="18">                           <span class="dt">Quantity</span> u2 v <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb18-19" data-line-number="19">                           <span class="dt">Quantity</span> (u1 <span class="ot">`Div`</span> u2) v</a>
<a class="sourceLine" id="cb18-20" data-line-number="20">(<span class="dt">Quantity</span> v1 u1) <span class="fu">/#</span> (<span class="dt">Quantity</span> v2 u2) <span class="fu">=</span></a>
<a class="sourceLine" id="cb18-21" data-line-number="21">  <span class="dt">Quantity</span> (v1 <span class="fu">/</span> v2) (u1 <span class="ot">`V.div`</span> u2)</a></code></pre></div>
<p>For all operations on quantities, one does the operation on the value and, in the case of multiplication and division, on the units separetly. For addition and subtraction the in-units must be the same. Nothing then happens with the unit.</p>
<p>How does one perform operations such as <code>sin</code> on a quantity with a <em>potential</em> unit? The answer is that the quantity must be unitless, and with the unit nothing happens. For the follwing functions, the quantites must be unitless.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb19-1" data-line-number="1"><span class="ot">sinq ::</span> (<span class="dt">Floating</span> v) <span class="ot">=&gt;</span> <span class="dt">Quantity</span> <span class="dt">One</span> v <span class="ot">-&gt;</span> <span class="dt">Quantity</span> <span class="dt">One</span> v</a>
<a class="sourceLine" id="cb19-2" data-line-number="2">sinq (<span class="dt">Quantity</span> v ul) <span class="fu">=</span> <span class="dt">Quantity</span> (sin v) ul</a>
<a class="sourceLine" id="cb19-3" data-line-number="3"></a>
<a class="sourceLine" id="cb19-4" data-line-number="4"><span class="ot">cosq ::</span> (<span class="dt">Floating</span> v) <span class="ot">=&gt;</span> <span class="dt">Quantity</span> <span class="dt">One</span> v <span class="ot">-&gt;</span> <span class="dt">Quantity</span> <span class="dt">One</span> v</a>
<a class="sourceLine" id="cb19-5" data-line-number="5">cosq (<span class="dt">Quantity</span> v ul) <span class="fu">=</span> <span class="dt">Quantity</span> (cos v) ul</a></code></pre></div>
<p>We quickly realize a pattern, so let’s generalize a bit.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb20-1" data-line-number="1"><span class="ot">qmap ::</span> (a <span class="ot">-&gt;</span> b) <span class="ot">-&gt;</span> <span class="dt">Quantity</span> <span class="dt">One</span> a <span class="ot">-&gt;</span> <span class="dt">Quantity</span> <span class="dt">One</span> b</a>
<a class="sourceLine" id="cb20-2" data-line-number="2">qmap f (<span class="dt">Quantity</span> v ul) <span class="fu">=</span> <span class="dt">Quantity</span> (f v) ul</a>
<a class="sourceLine" id="cb20-3" data-line-number="3"></a>
<a class="sourceLine" id="cb20-4" data-line-number="4"><span class="kw">type</span> <span class="dt">UnaryScalar</span> v <span class="fu">=</span> <span class="dt">Quantity</span> <span class="dt">One</span> v <span class="ot">-&gt;</span> <span class="dt">Quantity</span> <span class="dt">One</span> v</a>
<a class="sourceLine" id="cb20-5" data-line-number="5"></a>
<a class="sourceLine" id="cb20-6" data-line-number="6">sinq, cosq, asinq, acosq, atanq, expq,<span class="ot"> logq ::</span> (<span class="dt">Floating</span> v) <span class="ot">=&gt;</span></a>
<a class="sourceLine" id="cb20-7" data-line-number="7">  <span class="dt">UnaryScalar</span> v</a>
<a class="sourceLine" id="cb20-8" data-line-number="8">sinq  <span class="fu">=</span> qmap sin</a>
<a class="sourceLine" id="cb20-9" data-line-number="9">cosq  <span class="fu">=</span> qmap cos</a>
<a class="sourceLine" id="cb20-10" data-line-number="10">asinq <span class="fu">=</span> qmap asin</a>
<a class="sourceLine" id="cb20-11" data-line-number="11">acosq <span class="fu">=</span> qmap acos</a>
<a class="sourceLine" id="cb20-12" data-line-number="12">atanq <span class="fu">=</span> qmap atan</a>
<a class="sourceLine" id="cb20-13" data-line-number="13">expq  <span class="fu">=</span> qmap exp</a>
<a class="sourceLine" id="cb20-14" data-line-number="14">logq  <span class="fu">=</span> qmap log</a></code></pre></div>
<p>Why not make <code>Quantity</code> an instance of <code>Num</code>, <code>Fractional</code>, <code>Floating</code> och <code>Functor</code>? The reason is that the functions of those type classes have the following type</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb21-1" data-line-number="1"><span class="ot">(*) ::</span> (<span class="dt">Num</span> a) <span class="ot">=&gt;</span> a <span class="ot">-&gt;</span> a <span class="ot">-&gt;</span> a</a></code></pre></div>
<p>which isn’t compatible with <code>Quantity</code> since multiplication with <code>Quantity</code> has the following type</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb22-1" data-line-number="1"><span class="ot">(*#) ::</span> (<span class="dt">Num</span> v) <span class="ot">=&gt;</span> <span class="dt">Quantity</span> u1 v <span class="ot">-&gt;</span> <span class="dt">Quantity</span> u2 v <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb22-2" data-line-number="2">                   <span class="dt">Quantity</span> (u1 <span class="ot">`Mul`</span> u2) v</a></code></pre></div>
<p>The input here may actually be of <em>different</em> types, and the output has a type depending on the types of the input. However, the <em>kind</em> of the inputs and output are the same, namely <code>Quantity</code>. We’ll just have to live with not being able to make <code>Quantity</code> a <code>Num</code>-instance.</p>
<p>However, operations with only scalars (type <code>One</code>) has types compatible with <code>Num</code>. Therefore a possibility would’ve been to make <code>Quantity One</code> a <code>Num</code>-instance.</p>
<h2 id="syntactic-sugar">Syntactic sugar</h2>
<p>In order to create a value representing a certain distance (5 meters, for example) one does the following</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb23-1" data-line-number="1"><span class="ot">distance ::</span> <span class="dt">Quantity</span> <span class="dt">T.Length</span> <span class="dt">Double</span></a>
<a class="sourceLine" id="cb23-2" data-line-number="2">distance <span class="fu">=</span> <span class="dt">Quantity</span> <span class="dv">5</span> V.length</a></code></pre></div>
<p>Writing that way each time is very clumsy. You can also do “dumb” things such as</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb24-1" data-line-number="1"><span class="ot">distance ::</span> <span class="dt">Quantity</span> <span class="dt">T.Length</span> <span class="dt">Double</span></a>
<a class="sourceLine" id="cb24-2" data-line-number="2">distance <span class="fu">=</span> <span class="dt">Quantity</span> <span class="dv">5</span> V.time</a></code></pre></div>
<p>with different units on value-level and type-level.</p>
<p>To solve these two problems we will introduce some syntactic sugar. First some pre-made values for the 7 base units and the scalar.</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb25-1" data-line-number="1">length<span class="ot"> ::</span> (<span class="dt">Num</span> v) <span class="ot">=&gt;</span> <span class="dt">Quantity</span> <span class="dt">Length</span> v</a>
<a class="sourceLine" id="cb25-2" data-line-number="2">length <span class="fu">=</span> <span class="dt">Quantity</span> <span class="dv">0</span> V.length</a>
<a class="sourceLine" id="cb25-3" data-line-number="3"></a>
<a class="sourceLine" id="cb25-4" data-line-number="4"><span class="ot">mass ::</span> (<span class="dt">Num</span> v) <span class="ot">=&gt;</span> <span class="dt">Quantity</span> <span class="dt">Mass</span> v</a>
<a class="sourceLine" id="cb25-5" data-line-number="5">mass <span class="fu">=</span> <span class="dt">Quantity</span> <span class="dv">0</span> V.mass</a>
<a class="sourceLine" id="cb25-6" data-line-number="6"></a>
<a class="sourceLine" id="cb25-7" data-line-number="7"><span class="ot">time ::</span> (<span class="dt">Num</span> v) <span class="ot">=&gt;</span> <span class="dt">Quantity</span> <span class="dt">Time</span> v</a>
<a class="sourceLine" id="cb25-8" data-line-number="8">time <span class="fu">=</span> <span class="dt">Quantity</span> <span class="dv">0</span> V.time</a>
<a class="sourceLine" id="cb25-9" data-line-number="9"></a>
<a class="sourceLine" id="cb25-10" data-line-number="10"><span class="ot">current ::</span> (<span class="dt">Num</span> v) <span class="ot">=&gt;</span> <span class="dt">Quantity</span> <span class="dt">Current</span> v</a>
<a class="sourceLine" id="cb25-11" data-line-number="11">current <span class="fu">=</span> <span class="dt">Quantity</span> <span class="dv">0</span> V.current</a>
<a class="sourceLine" id="cb25-12" data-line-number="12"></a>
<a class="sourceLine" id="cb25-13" data-line-number="13"><span class="ot">temperature ::</span> (<span class="dt">Num</span> v) <span class="ot">=&gt;</span> <span class="dt">Quantity</span> <span class="dt">Temperature</span> v</a>
<a class="sourceLine" id="cb25-14" data-line-number="14">temperature <span class="fu">=</span> <span class="dt">Quantity</span> <span class="dv">0</span> V.temperature</a>
<a class="sourceLine" id="cb25-15" data-line-number="15"></a>
<a class="sourceLine" id="cb25-16" data-line-number="16"><span class="ot">substance ::</span> (<span class="dt">Num</span> v) <span class="ot">=&gt;</span> <span class="dt">Quantity</span> <span class="dt">Substance</span> v</a>
<a class="sourceLine" id="cb25-17" data-line-number="17">substance <span class="fu">=</span> <span class="dt">Quantity</span> <span class="dv">0</span> V.substance</a>
<a class="sourceLine" id="cb25-18" data-line-number="18"></a>
<a class="sourceLine" id="cb25-19" data-line-number="19"><span class="ot">luminosity ::</span> (<span class="dt">Num</span> v) <span class="ot">=&gt;</span> <span class="dt">Quantity</span> <span class="dt">Luminosity</span> v</a>
<a class="sourceLine" id="cb25-20" data-line-number="20">luminosity <span class="fu">=</span> <span class="dt">Quantity</span> <span class="dv">0</span> V.luminosity</a>
<a class="sourceLine" id="cb25-21" data-line-number="21"></a>
<a class="sourceLine" id="cb25-22" data-line-number="22"><span class="ot">one ::</span> (<span class="dt">Num</span> v) <span class="ot">=&gt;</span> <span class="dt">Quantity</span> <span class="dt">One</span> v</a>
<a class="sourceLine" id="cb25-23" data-line-number="23">one <span class="fu">=</span> <span class="dt">Quantity</span> <span class="dv">0</span> V.one</a></code></pre></div>
<p>And now the sugar.</p>
<p>[PaJa: här skulle man kunna använda multiplikation, ifall enheterna hade 1 som värde. Kommentera eller implementera.]</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb26-1" data-line-number="1"><span class="ot">(#) ::</span> (<span class="dt">Num</span> v) <span class="ot">=&gt;</span> v <span class="ot">-&gt;</span> <span class="dt">Quantity</span> u v <span class="ot">-&gt;</span> <span class="dt">Quantity</span> u v</a>
<a class="sourceLine" id="cb26-2" data-line-number="2">v <span class="fu">#</span> (<span class="dt">Quantity</span> _ u) <span class="fu">=</span> <span class="dt">Quantity</span> v u</a></code></pre></div>
<p>The intended usage of the function is the following</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb27-1" data-line-number="1">ghci<span class="fu">&gt;</span> <span class="kw">let</span> myDistance <span class="fu">=</span> <span class="dv">5</span> <span class="fu">#</span> length</a>
<a class="sourceLine" id="cb27-2" data-line-number="2">ghci<span class="fu">&gt;</span> <span class="fu">:</span>t myDistance</a>
<a class="sourceLine" id="cb27-3" data-line-number="3"><span class="ot">t ::</span> <span class="dt">Num</span> v <span class="ot">=&gt;</span> <span class="dt">Quantity</span> <span class="dt">Length</span> v</a>
<a class="sourceLine" id="cb27-4" data-line-number="4">ghci<span class="fu">&gt;</span> myDistance</a>
<a class="sourceLine" id="cb27-5" data-line-number="5"><span class="dv">5</span> m</a></code></pre></div>
<p>To create a <code>Quantity</code> with a certain value (here <code>5</code>) and a certain unit (here <code>length</code>), you write as above and get the correct unit on both value-level and type-level.</p>
<p><code>length</code>, <code>mass</code> and so on are just dummy-values with the correct unit (on both value-level and type-level) in order to easier create <code>Quantity</code> values. Any value with the correct unit on both levels can be used as the right hand argument.</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb28-1" data-line-number="1">ghci<span class="fu">&gt;</span> <span class="kw">let</span> otherPersonsDistance <span class="fu">=</span> <span class="dv">10</span> <span class="fu">#</span> length</a>
<a class="sourceLine" id="cb28-2" data-line-number="2">ghci<span class="fu">&gt;</span> <span class="kw">let</span> myDistance <span class="fu">=</span> <span class="dv">5</span> <span class="fu">#</span> otherPersonsDistance</a>
<a class="sourceLine" id="cb28-3" data-line-number="3">ghci<span class="fu">&gt;</span> <span class="fu">:</span>t myDistance</a>
<a class="sourceLine" id="cb28-4" data-line-number="4"><span class="ot">t ::</span> <span class="dt">Num</span> v <span class="ot">=&gt;</span> <span class="dt">Quantity</span> <span class="dt">Length</span> v</a>
<a class="sourceLine" id="cb28-5" data-line-number="5">ghci<span class="fu">&gt;</span> myDistance</a>
<a class="sourceLine" id="cb28-6" data-line-number="6"><span class="dv">5</span> m</a></code></pre></div>
<p>Precisely the same result.</p>
<p>We want to maintain the invariant that the unit on value-level and type-level always match. The pre-made values from above maintain it, and so does the arithmetic operations we previously created. Therefore, we only export those from this module! The user will have no choice but to use these constructs and hence the invariant will be maintained.</p>
<p>If the user needs other units than the base units (which it probably will), the follwing example shows how it’s done.</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb29-1" data-line-number="1">ghci<span class="fu">&gt;</span> <span class="kw">let</span> myLength <span class="fu">=</span> <span class="dv">5</span> <span class="fu">#</span> length</a>
<a class="sourceLine" id="cb29-2" data-line-number="2">ghci<span class="fu">&gt;</span> <span class="kw">let</span> myTime <span class="fu">=</span> <span class="dv">2</span> <span class="fu">#</span> time</a>
<a class="sourceLine" id="cb29-3" data-line-number="3">ghci<span class="fu">&gt;</span> <span class="kw">let</span> myVelocity <span class="fu">=</span> myLength <span class="fu">/#</span> myTime</a>
<a class="sourceLine" id="cb29-4" data-line-number="4">ghci<span class="fu">&gt;</span> myVelocity</a>
<a class="sourceLine" id="cb29-5" data-line-number="5"><span class="fl">2.5</span> m<span class="fu">/</span>s</a></code></pre></div>
<p>New units are created “on demand”. Furthermore</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb30-1" data-line-number="1">ghci<span class="fu">&gt;</span> <span class="kw">let</span> velocity <span class="fu">=</span> myVelocity</a>
<a class="sourceLine" id="cb30-2" data-line-number="2">ghci<span class="fu">&gt;</span> <span class="kw">let</span> otherVelocity <span class="fu">=</span> <span class="dv">188</span> <span class="fu">#</span> velocity</a></code></pre></div>
<p>it’s possible to use the sugar from before on user-defined units.</p>
<p>TODO: Dessa har alla Double som värdetyp. Hur förhindra det? Explicita typsignaturer löser det, men man vill inte att “användaren” ska <em>behöva</em> och <em>få</em> göra det för att behålla den tidigare nämnda invarianten.</p>
<p>Just for convenience sake we’ll define a bunch of common composite units.</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb31-1" data-line-number="1">velocity     <span class="fu">=</span> length   <span class="fu">/#</span> time</a>
<a class="sourceLine" id="cb31-2" data-line-number="2">acceleration <span class="fu">=</span> velocity <span class="fu">/#</span> time</a>
<a class="sourceLine" id="cb31-3" data-line-number="3">force        <span class="fu">=</span> mass     <span class="fu">*#</span> acceleration</a>
<a class="sourceLine" id="cb31-4" data-line-number="4">momentum     <span class="fu">=</span> force    <span class="fu">*#</span> time</a></code></pre></div>
<h2 id="a-physics-example">A physics example</h2>
<p>To conclude this chapter, we show an example on how to code an exercise and its solution in this domain specific language we’ve created for quantities.</p>
<p>The code comments show what GHCi prints for that row.</p>
<p>The exercise is “A dog runs, jumps and lands sliding on a carriage. The dog weighs <code>40 kg</code> and runs in <code>8 m/s</code>. The carriage weighs <code>190 kg</code>. The coefficient of friction between the dog’s paws and the carriage is <code>0.7</code>.”</p>
<p>This is illustrated in the painting below.</p>
<p><img src="Exercise.png" alt="" style="width: 600px;"/></p>
<ol type="a">
<li>Calculate the (shared) final velocity of the dog and the carriage.</li>
</ol>
<div class="sourceCode" id="cb32"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb32-1" data-line-number="1">mDog      <span class="fu">=</span> <span class="dv">40</span> <span class="fu">#</span> mass    <span class="co">-- 40 kg</span></a>
<a class="sourceLine" id="cb32-2" data-line-number="2">viDog     <span class="fu">=</span> <span class="dv">8</span> <span class="fu">#</span> velocity <span class="co">-- 8 m/s</span></a>
<a class="sourceLine" id="cb32-3" data-line-number="3">mCarriage <span class="fu">=</span> <span class="dv">190</span> <span class="fu">#</span> mass   <span class="co">-- 190 kg</span></a>
<a class="sourceLine" id="cb32-4" data-line-number="4">u         <span class="fu">=</span> <span class="fl">0.7</span> <span class="fu">#</span> one    <span class="co">-- 0.7</span></a></code></pre></div>
<p>No external forces are acting on the dog and the carriage. Hence the momentum of the system is preserved.</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb33-1" data-line-number="1">piSystem <span class="fu">=</span> mDog <span class="fu">*#</span> viDog <span class="co">-- 320 kg*m/s</span></a>
<a class="sourceLine" id="cb33-2" data-line-number="2">pfSystem <span class="fu">=</span> piSystem      <span class="co">-- 320 kg*m/s</span></a></code></pre></div>
<p>In the end the whole system has a shared velocity of its shared mass.</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb34-1" data-line-number="1">mSystem  <span class="fu">=</span> mDog <span class="fu">+#</span> mCarriage   <span class="co">-- 230 kg</span></a>
<a class="sourceLine" id="cb34-2" data-line-number="2">vfSystem <span class="fu">=</span> pfSystem <span class="fu">/#</span> mSystem <span class="co">-- 1.39 m/s</span></a></code></pre></div>
<ol start="2" type="a">
<li>Calculate the force of friction acting on the dog.</li>
</ol>
<div class="sourceCode" id="cb35"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb35-1" data-line-number="1">fFriction <span class="fu">=</span> u <span class="fu">*#</span> fNormal        <span class="co">-- 275 kg*m/s^2</span></a>
<a class="sourceLine" id="cb35-2" data-line-number="2">fNormal   <span class="fu">=</span> mDog <span class="fu">*#</span> g           <span class="co">-- 393 kg*m/s^2</span></a>
<a class="sourceLine" id="cb35-3" data-line-number="3">g         <span class="fu">=</span> <span class="fl">9.82</span> <span class="fu">#</span> acceleration <span class="co">-- 9.82 m/s^2</span></a></code></pre></div>
<ol start="3" type="a">
<li>For how long time does the dog slide on the carriage?</li>
</ol>
<div class="sourceCode" id="cb36"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb36-1" data-line-number="1">aDog <span class="fu">=</span> fFriction <span class="fu">/#</span> mDog <span class="co">-- 6.87 m/s^2</span></a></code></pre></div>
<div class="sourceCode" id="cb37"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb37-1" data-line-number="1">vDelta <span class="fu">=</span> mDog <span class="fu">-#</span> vfSystem</a></code></pre></div>
<pre><code>* Couldn&#39;t match type &#39;Numeric.NumType.DK.Integers.Neg1
                 with &#39;Numeric.NumType.DK.Integers.Zero
...</code></pre>
<p>Whoops! That’s not a good operation. Luckily the compiler caught it.</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb39-1" data-line-number="1">vDelta <span class="fu">=</span> viDog <span class="fu">-#</span> vfSystem <span class="co">-- 6.60 m/s</span></a>
<a class="sourceLine" id="cb39-2" data-line-number="2">tSlide <span class="fu">=</span> vDelta <span class="fu">/#</span> aDog    <span class="co">-- 0.96 s</span></a></code></pre></div>

    </main>

    <footer>
      Licensed under the GPL by the Kandidatboisen (2018)
    </footer>
  </body>
</html>
